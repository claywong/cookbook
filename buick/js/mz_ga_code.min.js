//***********************************************************
// Name: Buick Mobile miaozhen与ga整合一起的 v 2.4
// Author: Wally.he@hylinkad.com
// Date: 2014.07.14 10:51
// Desc: 秒针代码与GA代码整合, 提供一个公共的方法一起调用 {DEFAULT=10199}
//		*****在每个页面head处加上<script src="http://m.buick.com.cn/js/mz_ga_code.min.js" ></script>****
//		这会自动加载mz与ga的配制代码, mz type {pv:1, event:2, leads:4}
// 		共有4个方法, 1个属性, 都在hylink下
//		1. hylink.isDebug = false;
//			默认值为false, 当为true时, 调用四个方法会console.log 方法名与参数值.
//		2. hylink.setGaPath(p);
//			定义GA PV的目录, 默认为空字串, 同一页面只需定义一次前缀, 
//			参数 p: String, PV的前缀目录, 如:"/encore", "/2014promotion/excellent", "/golf/new-cars/2014"
//			例子: hylink.setGaPath("/encore");
//		3. hylink.trackPV(mzPage,gaPage);
//			触发一次"曝光"(PV), mz的曝光可以为中文字符, GA的PV只能是英文路径. mz type=1
//			参数 mzPage: String, 参考xls的曝光值, 支持中文字符, 如:"产品首页", 
//			参数 gaPage: String, 参考xls, 只能为英文路径, 当这些PV都在某个目录下时, 需要定义setGaPath(p),
//			例子: 在/encore目录下的首页, 则先调用hylink.setGaPath("/encore"); 再调用hylink.tracePV("昴克拉-首页", "/home");
//		4. hylink.trackEvent(mzBtn,category, action, label);
//			触发一次"点击"(Event), 第一个参数为mz的点击名称, 后三个为GA的Event参数, mz type=2
//			参数 mzBtn: String, 参考xls的点击值,
//			参数 category: String, GA事件分类
//			参数 action: String, GA事件操作, 如 click
//			参数 label: String, GA事件名称, 其实与mzBtn按键名称差不多
//			例子: hylink.trackEvent("试驾提交", "底部", "click", "试驾提交");
//		5. hylink.trackLeads(name, mobile, leadsId);
//			当试驾成功后, 调用此方法, 把姓名, 手机号,与BUxxxxxx值传入, mz type=4
//			参数 name: String 姓名
//			参数 mobile: String 11位手机号
//			参数 leadsId[option]: 试驾接口返回的BU id
//			例子: hylink.trackLeads("王小二", "13333333333", "BU045345");
//
//		v1.1 增加自定义mz 自定义的type
//		v1.2 把GA code 整合在一起，不再加载/js/ga_ua_code.js文件
//		v1.3 自动获取当前项目url，不需要再手动调用setGaPath("/path/");
//		v1.4 增加域名判断, 避免因为chevy与buick搞错, 修改参数为空时提示信息
//		v1.5 增加sgmlink 监测代码
//		v2.0 可定义mz 参数, 可以script 标签添加 data-mzid='xxxxx' 这样来定义另一个秒针id, 11004是迈锐宝1000迈的mz id, 10199是默认的buick mobile
//		v2.1 更换sgmlink 监测代码
//		v2.2 增加uniclick代码
//		v2.3 trackPV, trackEvent增加一个ga参数 gaParamObj, 参数可为:{'nonInteraction': 1}
//		v2.4 增加sgm tracking 自定义events, 
//***********************************************************

window.__MIAOZHEN_CiQ_ID__ = 10199;////type: {pv:1, event:2, leads:4}

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

//<!--uniclick Analytics JS代码-->
var _utaq = _utaq || [];
//_utaq.push(["trackPageView"]);
_utaq.push(["openUtHeatMapOpen"]);
_utaq.push(["enableLinkTracking"]);
(function() {
var utu=(("https:" == document.location.protocol) ? "https" : "http") + "://sit.gentags.net/";
_utaq.push(["setTrackerUrl", utu+"site/unids.gif"]);
_utaq.push(["setSiteId", "1457"]);
var t=parseInt((new Date()).getTime()/1000);
var utd=document, ut=utd.createElement("script"), s=utd.getElementsByTagName("script")[0]; ut.type="text/javascript";
ut.defer=true; ut.async=true; ut.src=utu+"adagent/js/uta.js?v="+(t-t%300); s.parentNode.insertBefore(ut,s);
if (typeof _uni_bind != 'function'){function _uni_bind(t,tid,cid,act,pro){var pro = pro || '';_utaq.push(["trackCustomEvent", pro+'cmpp/uniut.gif','action='+act+'&openid='+tid+'&contactid='+cid+'&opentype='+t]);}}
})();


(function(i,d,t,o,u,h,s,f){i[t]=i[t]||[],i[t].push(h);i[h]=i[h]||function(){
return (i[h].q=i[h].q||[]).push(arguments)};s=d.createElement(o);s.src=u;
s.async=1;f=d.getElementsByTagName(o)[0];f.parentNode.insertBefore(s,f);
})(window,document,"HyperAnalyticsObject","script","//collector.sgmlink.com/hwt.js?v=1.6","_sgma");
_sgma("create","5",{
    "storage_id":"_hid",
    "api_url":"//collector.sgmlink.com",
    "swf_url":"//collector.sgmlink.com/storage.swf#",
    "iframe_url":"//collector.sgmlink.com/storage.html",
});

(function() {
var url = "http://sgm.m.cn.miaozhen.com/x.gif?v=sgm_mapping&o=http://collector.sgmlink.com/cm?_t=i&_sp=miaozhen&_spid=__M-MZID__";
var img =  new Image(1,1);
img.onload = img.onerror = function() {};
img.src = url;
})();

if((location.hostname=="localhost" && location.hostname=="127.0.0.1" && location.hostname.indexOf("192.168.")!=0) &&
	location.hostname.indexOf('buick.com.cn')==-1)	
		alert('调用[别克Mobile]"mz_ga_code.min.js"的域名不正确, 当前域名是:['+location.hostname+']');

(function (ga) {
	var s = document.getElementsByTagName("script");
	var p = false;
	for(var i=0,l=s.length;i<l;i++){
		var n = s[i];
		if(n.getAttribute('src') && n.getAttribute('src').indexOf("//m.buick.com.cn/js/mz_ga_code.")!=-1){
			if(n.getAttribute('data-disable-default-pageview')=="0" ){
				p = true;
			}
			var mzid = n.getAttribute("data-mzid");
			if(mzid!=null && mzid!='' && !isNaN(mzid)) window.__MIAOZHEN_CiQ_ID__ = parseInt(mzid);
			break;
		}
		
	}
	ga('create', 'UA-3331595-27', 'auto');//把cookies锁定于根域名及根目录下
	ga('require', 'displayfeatures');
	if(p){ga('send', 'pageview');_sgma("send","pageview");_utaq.push(["trackPageView"]);}//default tracking page view once.
})(ga);


if(!window['_CiQ'+__MIAOZHEN_CiQ_ID__]){
	(function() {
		var mzid = window.__MIAOZHEN_CiQ_ID__;
	    window['_CiQ'+mzid] = window['_CiQ'+mzid] || [];
	    window['_CiQ'+mzid].push(['_cookieUseRootDomain', true]);
	    var c = document.createElement('script');
	    c.type = 'text/javascript';
	    c.async = true;
	    c.charset = 'utf-8';
	    c.src = '//collect.cn.miaozhen.com/ca/'+mzid;
	    var h = document.getElementsByTagName('script')[0];
	    h.parentNode.insertBefore(c, h);
	})();

}

window.hylink = window.hylink || {};

(function(hy){
	var mzid = window.__MIAOZHEN_CiQ_ID__;
	window['_CiQ'+mzid] = window['_CiQ'+mzid] || [];
	var _gaPathArr = location.pathname.split("/");_gaPathArr.pop();
	var _gaPath = _gaPathArr.join("/");
	//
	function setGaPath(v){
		if(v.indexOf("/")!=0){
			v = "/"+v;
		}
		if(v.lastIndexOf("/")==v.length-1){
			v = v.substr(0, v.length-1);
		}
		_gaPath = v;
		_debug("hylink.setGaPath('"+v+"');//return '"+_gaPath+"'");
	}

	//曝光, PV
	function trackPV (mzPage,gaPage,gaParamObj){
		if(mzPage && mzPage!=""){
			window['_CiQ'+mzid].push(['_trackEvent', {
		     type: 1,
		     labels:[
		      {'页面名称':mzPage}
		      ],
		     values: [
		      {'数量':1}
		      ]
		    }]);
		    window.CClickiV3 && window.CClickiV3[mzid] && window.CClickiV3[mzid]._flushObserver(function(){});
		}else{
			_warm("hylink.trackPV() mzPage参数为空, 不会触发mz PV");
		}

	    //GA
	    if(gaPage && gaPage!=""){
	    	if(gaPage.indexOf("/")!=0){
				gaPage = "/"+gaPage;
			}
	    	var pp = _gaPath+gaPage;
	    	ga('send', 'pageview', pp, gaParamObj||{});_sgma("send","pageview", {url:pp});_utaq.push(['trackPageView',pp]);
	    }
	    _debug("hylink.trackPV('"+mzPage+"','"+_gaPath+gaPage+"')");
	}

	//Event 事件, {'nonInteraction': 1}
	function trackEvent(mzBtn,category, action, label, gaParamObj){
		if(mzBtn && mzBtn!=""){	
			window['_CiQ'+mzid].push(['_trackEvent', {
	         type: 2,
	         labels:[
	          {'按钮名称':mzBtn}
	          ],
	         values: [
	          {'数量':1}
	          ]
	        }]);
	        window.CClickiV3 && window.CClickiV3[mzid] && window.CClickiV3[mzid]._flushObserver(function(){});
    	}else{
    		_warm("hylink.trackEvent() mzBtn参数为空, 不会触发mz事件");
    	}
    	//GA
        if(label && label!=""){
        	ga('send', 'event', category, action, label, gaParamObj||{});_utaq.push(['trackEvent', category, action, label]);//_sgma("send","event", category, action, label);// todo, next version
        }
        _debug("hylink.trackEvent('"+mzBtn+"','"+category+"','"+action+",'"+label+"')");
	}

	//试驾成功
	function trackLeads(name, mobile, leadsId, paramObj){
		if(name && mobile && name!="" && mobile!=""){
			window['_CiQ'+mzid].push(['_trackEvent', {
				type: 4,
				labels: leadsId!=null && leadsId!="" ? [{'姓名':name},{'手机':mobile},{'LedsID':leadsId}] : 
														[{'姓名':name},{'手机':mobile}],
				values: [
					{'数量':1}
					]
			}]);
			window.CClickiV3 && window.CClickiV3[mzid] && window.CClickiV3[mzid]._flushObserver(function(){});
		}else{
			_error("hylink.trackLeads(name, mobile, leadsId) 参数为空");
		}
		if(leadsId && leadsId!="")	ga('set', 'dimension1', 'testdrive');
		if(paramObj){//uniclick
			_utaq.push(['setCustomVariable',1,'salesleads-order', 
				(paramObj.trycar ? paramObj.trycar : '')+'&'+
				(paramObj.dealer ? paramObj.dealer : '')+'&'+
				(paramObj.realname ? paramObj.realname : '')+'&'+
				(paramObj.mobile ? paramObj.mobile : '')+'&'+
				(paramObj.buyplan ? paramObj.buyplan : ''),'page']);
		}
	}
/*
	function trackLeadsT1(name, mobile, leadsId) {
        if (!name || !mobile || !leadsId || name == "" || mobile == "" || leadsId == "") _error("hylink.trackLeads() 参数为空");
        window._CiQ10199 = window._CiQ10199 || [];
        window._CiQ10199.push(['_trackEvent', {
            type: 5,
            labels: [
                { '姓名': name },
                { '手机': mobile },
                { 'LeadsID': leadsId }
            ],
            values: [
                { '数量': 1 }
            ]
        }]);
        window.CClickiV3 && window.CClickiV3[10199] && window.CClickiV3[10199]._flushObserver(function () { });
    }


    function trackLeadsT2(name, mobile, leadsId) {
        if (!name || !mobile || name == "" || mobile == "") _error("hylink.trackLeads() 参数为空");
        window._CiQ10199 = window._CiQ10199 || [];
        window._CiQ10199.push(['_trackEvent', {
            type: 7,
            labels: [
                { '姓名': name },
                { '手机': mobile }
            ],
            values: [
                { '数量': 1 }
            ]
        }]);
        window.CClickiV3 && window.CClickiV3[10199] && window.CClickiV3[10199]._flushObserver(function () { });
    }*/


    /////////SGM tracking 自定义Events\\\\\\\\\\\\\\\\\\\
	function _sgmaAction(type, object){
		for(var prop in object){
			object[prop] = object[prop]==null ? '' : object[prop];
		}
		object.brand = "别克";
		if(object.car_type) object.car_type = _fixCarTypeName(object.car_type);
		_sgma('send','action', type, object);
	}

	function _fixCarTypeName(value){
		var retVal = value;
		if(value.indexOf('英朗')!=-1) retVal = "英朗";
		else if(value.indexOf('君越')!=-1) retVal = "君越";
		else if(value.indexOf('君威')!=-1) retVal = "君威";
		else if(value=="威朗") retVal = "威朗三厢";
		else if(value.indexOf('威朗两厢')!=-1 || value.indexOf("威朗GS")!=-1 || value.indexOf("威朗轿跑")!=-1) retVal = "威朗两厢/GS";
		else if(value.indexOf('凯越')!=-1) retVal = "凯越";
		else if(value=='GL8') retVal = "GL8商务车";
		return retVal;
	}
	
	//exObj {gender, age, dealerName, city, province}
	function _sgmaTestDrive(name, mobile, car, buyPlan, exObj){
		var obj = { name:name, phone:mobile, car_type:car, buying_plan:buyPlan, 
					gender:'', car_agency:'',city:'',province:''};
		if(Object.prototype.toString.call(exObj)=='[object Object]'){
			obj.gender = exObj.gender;
			obj.age = exObj.age;
			obj.car_agency = exObj.dealerName;
			obj.city = exObj.city;
			obj.province = exObj.province;
		}
		
		if(obj.car!=null && obj.car.indexOf("君越")!=-1){
			obj.car = "君越";
		}
		_sgmaAction('test_drive', obj);
	}
	
	function _sgmaCarConfig(car){
		var obj = {car_type:car};
		_sgmaAction('car_config', obj);
	}

	function _sgmaCarLoan(car){
		var obj = {};
		_sgmaAction('car_loan', obj);
	}

	function _sgmaSubmitLoan(name, mobile, car, buyPlan, province, city, gender, age){
		var obj = {name:name, phone:mobile, car_type:car, buying_plan:buyPlan, province:province, city:city, gender:gender, age:age};
		_sgmaAction('submit_loan', obj);

	}

	function _sgmaCalLoan(car){
		var obj = {car_type:car};
		_sgmaAction('cal_loan', obj);
	}

	function _sgmaStartCal(car, province, city){
		var obj = {car_type:car, province:province, city:city};
		_sgmaAction('cal_loan', obj);
	}

	function _sgmaPrice(car){
		var obj = {car_type:car};
		_sgmaAction('price', obj);
	}

	function _sgmaCarAgency(){
		var obj = {};
		_sgmaAction('car_agency', obj);
	}

	function _sgmaService(){
		var obj = {};
		_sgmaAction('service', obj);
	}

	function _sgmaExterior(car){
		var obj = {car_type:car};
		_sgmaAction('exterior', obj);
	}

	function _sgmaInterior(car){
		var obj = {car_type:car};
		_sgmaAction('interior', obj);
	}

	function _sgmaPower(car){
		var obj = {car_type:car};
		_sgmaAction('power', obj);
	}

	function _sgmaComfort(car){
		var obj = {car_type:car};
		_sgmaAction('comfort', obj);
	}

	function _sgmaSafety(car){
		var obj = {car_type:car};
		_sgmaAction('safety', obj);
	}



	/////////console
	var _console  = window.console || {};
	function _error(msg){
		_console['error'](msg);
	}

	function _warm(msg){
		_console['warn'](msg);
	}

	function _debug(msg){
		if(hy.isDebug)	_console['log'](msg);
	}


	hy.isDebug = false;
	hy.setGaPath = setGaPath;
	hy.trackPV = trackPV;
	hy.trackEvent = trackEvent;
	hy.trackLeads = trackLeads;
	//hy.trackLeadsT1 = trackLeadsT1;
    //hy.trackLeadsT2 = trackLeadsT2;

    //SGM tracking function
	hy.sgmaTestDrive = _sgmaTestDrive;
	hy.sgmaCarConfig = _sgmaCarConfig;
	hy.sgmaCarLoan = _sgmaCarLoan;
	hy.sgmaSubmitLoan = _sgmaSubmitLoan;
	hy.sgmaCalLoan = _sgmaCalLoan;
	//hy.sgmaStartCal = _sgmaStartCal;
	hy.sgmaCarAgency = _sgmaCarAgency;
	//hy.sgmaService = _sgmaService;
	hy.sgmaExterior = _sgmaExterior;
	hy.sgmaInterior = _sgmaInterior;
	hy.sgmaPower = _sgmaPower;
	hy.sgmaComfort = _sgmaComfort;
	hy.sgmaSafety = _sgmaSafety;
	//hy.sgmaPrice = _sgmaPrice;

})(hylink);



//***********************************************************
//UTM参数COOKIE 改成JS前端写入 以下代码, 将来会去除
//***********************************************************

(function(){
    var cookiename = "dcutmTracke";
    var cookievalue = "";
    var url = document.URL;
    if(url.indexOf("?") == -1 || GetQueryString("utm_source")==null || GetQueryString("utm_medium")==null || GetQueryString("utm_campaign")==null) 
    {
        var refurl=document.referrer;
        var parsurl="";
        cookiename = "dcutmTracke_browse";
        //官网部分判断
        if(url.indexOf("gl8_258/2014")!=-1)
        {
            parsurl = "Direct_PC_GL8-OfficialSite-2014";
        }
        else if(url.indexOf("excellext/2014")!=-1)
        {
            parsurl = "Direct_PC_XT-OfficialSite-shuai2014";
        }
        else if(url.indexOf("excellegt/gt2014")!=-1)
        {
            parsurl = "Direct_PC_GT-OfficialSite-GMACpromotion2014";
        }
        else if(url.indexOf("excelle/excelle2014")!=-1)
        {
            parsurl = "Direct_PC_Excelle-OfficialSite-KaiYueRenSheng2014";
        }
        else  if(url.indexOf("promotion")!=-1)
        {
            parsurl = "Direct_PC_Buick-OfficialSite-GMACpromotion";
        }
        //活动站默认值
        else  if(url.indexOf("enclave.buick.com.cn")!=-1)//昂科雷
        {
            parsurl = "Direct_PC_Enclave-Minsite";
        }  
        else  if(url.indexOf("encore.buick.com.cn")!=-1)//昂科拉
        {
            parsurl = "Direct_PC_Enclave-Minsite";
        }        
        else  if(url.indexOf("lacrosse.buick.com.cn")!=-1)//君越
        {
            parsurl = "Direct_PC_Lacrosse-Minsite";
        }  
        else  if(url.indexOf("newgs.buick.com.cn")!=-1)//君威GS
        {
            parsurl = "Direct_PC_GS-Minisite-Drive2Love";
        }  
        else  if(url.indexOf("newregal.buick.com.cn")!=-1)//君威
        {
            parsurl = "Direct_PC_Regal-Minsite";
        }           
        else 
        {
            parsurl = "Direct_PC_Buick-OfficialSite";
        }
        cookievalue="utm_campaign_browse="+parsurl;
    }
    else
    {
        var parsurl = url.substring(url.indexOf("?"));
        var utmvalue = ["utm_source", "utm_medium", "utm_campaign", "utm_content", "utm_term"];        
        for(var i=0;i<utmvalue.length;i++){
            var t = GetQueryString(utmvalue[i]);
            if(t!=null){
                cookievalue = cookievalue + utmvalue[i]+"="+t;  
            }
            if((i+1)!=utmvalue.length) {
                cookievalue = cookievalue + "&";
            }
        }          
    }    
    setCookie(cookiename,cookievalue,1);   
    
    function GetQueryString(name)
    { 
	    var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)"); 
	    var r = window.location.search.substr(1).match(reg); 
	    if (r!=null) return unescape(r[2]); return null; 
    }

    function setCookie(c_name,value,expiredays) {  
        var exdate=new Date();
        if(expiredays==null) {expiredays = 1;}
        exdate.setDate(exdate.getDate()+expiredays);
        if(c_name=="dcutmTracke_browse"){
            document.cookie=c_name+ "=" +value+";path=/;domain=buick.com.cn";
        }else{
            document.cookie=c_name+ "=" +value+((expiredays==null) ? "" : ";expires="+exdate.toGMTString())+";path=/;domain=buick.com.cn";
        }    
    }    
})();


